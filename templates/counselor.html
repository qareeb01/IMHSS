<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>Counselor Dashboard - IMHSS</title>
    <link
        rel="stylesheet"
        href="/static/css/Dashboard.css"
    >
</head>

<body>
    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="dashboard-layout">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar-left">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <svg
                        width="40"
                        height="40"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                        ></path>
                    </svg>
                </div>
                <h2 class="sidebar-title">IMHSS</h2>
                <p class="sidebar-subtitle">Mental Health Support</p>
            </div>

            <nav class="sidebar-nav">
                <a
                    href="#dashboard"
                    class="sidebar-link active"
                    data-tab="dashboard"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect
                            x="3"
                            y="3"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="14"
                            y="3"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="14"
                            y="14"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="3"
                            y="14"
                            width="7"
                            height="7"
                        ></rect>
                    </svg>
                    <span>Dashboard</span>
                </a>

                <a
                    href="#students"
                    class="sidebar-link"
                    data-tab="students"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2">
                        </path>
                        <circle
                            cx="9"
                            cy="7"
                            r="4"
                        ></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>My Students</span>
                </a>

                <a
                    href="#flagged"
                    class="sidebar-link"
                    data-tab="flagged"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                        ></path>
                        <line
                            x1="12"
                            y1="9"
                            x2="12"
                            y2="13"
                        ></line>
                        <line
                            x1="12"
                            y1="17"
                            x2="12.01"
                            y2="17"
                        ></line>
                    </svg>
                    <span>Flagged Messages</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="3"
                                y="11"
                                width="18"
                                height="11"
                                rx="2"
                                ry="2"
                            ></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <div class="user-info">
                        <p class="user-email">{{ session.get('email',
                            'counselor@imhss.app') }}</p>
                        <p class="user-role">Counselor</p>
                    </div>
                </div>
                <a
                    href="{{ url_for('IMHSS.logout') }}"
                    class="signout-btn"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4">
                        </path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line
                            x1="21"
                            y1="12"
                            x2="9"
                            y2="12"
                        ></line>
                    </svg>
                    <span>Sign Out</span>
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content-area">
            <!-- DASHBOARD TAB -->
            <section
                id="dashboard-tab"
                class="tab-content active"
            >
                <div class="content-header">
                    <h1>Counselor Dashboard</h1>
                    <p class="content-subtitle">Monitor your students' wellbeing
                    </p>
                    <button
                        id="enable-notifications-btn"
                        class="btn-enable-notifications"
                        style="display: none;"
                    >
                        <svg
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        Enable Notifications       
                    </button>
                </div>

                <!-- Stats Cards Grid -->
                <div class="stats-cards-grid">
                    <div class="stat-card-modern teal">
                        <div class="stat-content">
                            <p class="stat-label">My Students</p>
                            <h2 class="stat-number">{{
                                my_students_count|default(0) }}/5</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle
                                    cx="9"
                                    cy="7"
                                    r="4"
                                ></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="stat-card-modern orange">
                        <div class="stat-content">
                            <p class="stat-label">Flagged Messages</p>
                            <h2 class="stat-number">{{
                                flagged_messages_count|default(0) }}</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                ></path>
                                <line
                                    x1="12"
                                    y1="9"
                                    x2="12"
                                    y2="13"
                                ></line>
                                <line
                                    x1="12"
                                    y1="17"
                                    x2="12.01"
                                    y2="17"
                                ></line>
                            </svg>
                        </div>
                    </div>

                    <div class="stat-card-modern gray">
                        <div class="stat-content">
                            <p class="stat-label">Total Messages</p>
                            <h2 class="stat-number">{{
                                total_messages_count|default(0) }}</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        {% if my_students_count|default(0) <
                            5
                            %}
                            <a
                            href="{{ url_for('IMHSS.counselor_create_student') }}"
                            class="action-btn"
                        >
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle
                                    cx="8.5"
                                    cy="7"
                                    r="4"
                                ></circle>
                                <line
                                    x1="20"
                                    y1="8"
                                    x2="20"
                                    y2="14"
                                ></line>
                                <line
                                    x1="23"
                                    y1="11"
                                    x2="17"
                                    y2="11"
                                ></line>
                            </svg>
                            Register New Student
                            </a>
                            {% endif %}
                            <a
                                href="#flagged"
                                class="action-btn"
                                data-tab="flagged"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                    ></path>
                                </svg>
                                Review Flagged Messages
                            </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent High-Risk Alerts</h3>
                    {% if high_risk_flags %}
                    <div class="activity-list">
                        {% for flag in high_risk_flags[:5] %}
                        <div class="activity-item urgent">
                            <div class="activity-icon">⚠️</div>
                            <div class="activity-details">
                                <p class="activity-student">{{ flag.student.name
                                    if flag.student else 'Unknown' }}</p>
                                <p class="activity-message">{{
                                    flag.message.content[:100] if flag.message
                                    else 'Message unavailable' }}...</p>
                                <p class="activity-keywords">Keywords: {{ ',
                                    '.join(flag.detected_keywords) }}</p>
                                <p class="activity-time">{{
                                    flag.flagged_at.strftime('%B %d, %Y at %I:%M
                                    %p') if flag.flagged_at else 'Unknown time'
                                    }}</p>
                            </div>
                            <a
                                href="#flagged"
                                class="view-btn"
                                data-tab="flagged"
                            >Review</a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <p>No high-risk messages flagged</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- STUDENTS TAB -->
            <div id="students-tab" class="tab-content">
    <div class="tab-header">
        <h2>My Students</h2>
        <p class="tab-subtitle">{{ my_students_count }} students assigned</p>
        <a href="{{ url_for('IMHSS.counselor_create_student') }}" class="register-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Register New Student
        </a>
    </div>

    {% if my_students %}
    <div class="students-grid">
        {% for student in my_students %}
        <div class="student-card {% if student.token_expired %}token-expired{% endif %}">
            <div class="student-card-header">
                <div class="student-avatar">{{ student.name[0].upper() }}</div>
                <div class="student-info">
                    <h3>{{ student.name }}</h3>
                    <p class="student-matric">{{ student.matric }}</p>
                    <p class="student-dept">{{ student.department }}</p>
                </div>
                
                <!-- TOKEN STATUS BADGE -->
                {% if student.token_expired %}
                <span class="token-badge expired">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Token Expired
                </span>
                {% elif student.days_until_expiry <= 2 %}
                <span class="token-badge expiring-soon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    </svg>
                    Expires in {{ student.days_until_expiry }} day{{ 's' if student.days_until_expiry != 1 else '' }}
                </span>
                {% else %}
                <span class="token-badge active">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    {{ student.days_until_expiry }} days left
                </span>
                {% endif %}
            </div>

            <div class="student-card-body">
                <div class="student-detail">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">{{ student.email }}</span>
                </div>
                
                <div class="student-detail">
                    <span class="detail-label">Access Token:</span>
                    <span class="detail-value token-display">{{ student.access_token }}</span>
                </div>

                {% if student.token_expires_at %}
                <div class="student-detail">
                    <span class="detail-label">Token Expires:</span>
                    <span class="detail-value">{{ student.token_expires_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                </div>
                {% endif %}
            </div>

            <div class="student-card-actions">
                <a href="{{ url_for('IMHSS.counselor_view_student_messages', student_id=student._id) }}" 
                   class="btn-view-messages">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    View Messages
                </a>

                <!-- TOKEN REGENERATION BUTTON -->
                {% if student.token_expired or student.days_until_expiry <= 2 %}
                <form action="{{ url_for('IMHSS.counselor_regenerate_token', student_id=student._id) }}" 
                      method="POST" 
                      style="display: inline;"
                      onsubmit="return confirm('Generate new 7-day token for {{ student.name }}?');">
                    <button type="submit" class="btn-regenerate-token">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        {% if student.token_expired %}
                        Generate New Token
                        {% else %}
                        Renew Token Early
                        {% endif %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <h3>No Students Yet</h3>
        <p>Register your first student to get started</p>
        <a href="{{ url_for('IMHSS.counselor_create_student') }}" class="btn-primary">Register Student</a>
    </div>
    {% endif %}
</div>

    <!-- FLAGGED MESSAGES TAB -->
    <section
        id="flagged-tab"
        class="tab-content"
    >
        <div class="content-header">
            <h1>Flagged Messages</h1>
            <p class="content-subtitle">Review high-risk student messages</p>
        </div>

        {% if high_risk_flags %}
        <div class="flagged-messages-list">
            {% for flag in high_risk_flags %}
            <div class="flag-card {% if not flag.reviewed %}urgent{% endif %}">
                <div class="flag-header">
                    <div class="flag-student">
                        <div class="student-avatar-small">
                            {{ flag.student.name[0].upper() if flag.student else
                            '?' }}
                        </div>
                        <div>
                            <h4>{{ flag.student.name if flag.student else
                                'Unknown Student' }}</h4>
                            <p class="flag-time">{{ flag.flagged_at.strftime('%B
                                %d, %Y at %I:%M %p') if flag.flagged_at else
                                'Unknown time' }}</p>
                        </div>
                    </div>
                    {% if not flag.reviewed %}
                    <span class="risk-badge high">High Risk</span>
                    {% else %}
                    <span class="risk-badge reviewed">Reviewed</span>
                    {% endif %}
                </div>

                <div class="flag-content">
                    <div class="flag-keywords">
                        <strong>Detected Keywords:</strong>
                        {% for keyword in flag.detected_keywords %}
                        <span class="keyword-tag">{{ keyword }}</span>
                        {% endfor %}
                    </div>

                    <div class="flag-message">
                        <p><strong>Student Message:</strong></p>
                        <p class="message-text">{{ flag.message.content if
                            flag.message else 'Message unavailable' }}</p>
                    </div>

                    <div class="flag-ai-response">
                        <p><strong>AI Response:</strong></p>
                        <p class="response-text">{{ flag.message.ai_response if
                            flag.message else 'Response unavailable' }}</p>
                    </div>
                </div>

                {% if not flag.reviewed %}
                <div class="flag-actions">
                    <form
                        method="POST"
                        action="{{ url_for('IMHSS.counselor_review_flag', flag_id=flag._id) }}"
                        class="review-form"
                    >
                        <textarea
                            name="notes"
                            placeholder="Add notes about your follow-up action..."
                            rows="2"
                            class="review-notes"
                        ></textarea>
                        <button
                            type="submit"
                            class="btn-mark-reviewed"
                        >Mark as Reviewed</button>
                    </form>
                </div>
                {% else %}
                <div class="flag-reviewed-info">
                    <p><strong>Reviewed by:</strong> You on {{
                        flag.reviewed_at.strftime('%B %d, %Y at %I:%M %p') if
                        flag.reviewed_at else 'Unknown' }}</p>
                    {% if flag.notes %}
                    <p><strong>Notes:</strong> {{ flag.notes }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state-large">
            <svg
                width="64"
                height="64"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
            >
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <h3>No Flagged Messages</h3>
            <p>All clear! No high-risk messages require your attention.</p>
        </div>
        {% endif %}
    </section>
    </main>
    </div>

    <script src="/static/js/dashboard.js"></script>
</body>

</html>