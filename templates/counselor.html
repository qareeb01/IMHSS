<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>Counselor Dashboard - IMHMS</title>
    <link
        rel="stylesheet"
        href="/static/css/Dashboard.css"
    >
    <meta
        name="theme-color"
        content="#5a8a9c"
    >
</head>

<body>
    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- MOBILE HAMBURGER BUTTON -->
    <button
        class="mobile-menu-btn"
        id="mobileMenuBtn"
        aria-label="Open navigation menu"
    >
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div
        class="sidebar-overlay"
        id="sidebarOverlay"
    ></div>

    <div class="dashboard-layout">
        <!-- LEFT SIDEBAR -->
        <aside
            class="sidebar-left"
            id="sidebar"
        >
            <div class="sidebar-header">
                <div class="logo-icon">
                    <svg
                        width="40"
                        height="40"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                        ></path>
                    </svg>
                </div>
                <h2 class="sidebar-title">IMHMS</h2>
                <p class="sidebar-subtitle">Mental Health Monitoring System</p>
            </div>

            <nav class="sidebar-nav">
                <a
                    href="#dashboard"
                    class="sidebar-link active"
                    data-tab="dashboard"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect
                            x="3"
                            y="3"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="14"
                            y="3"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="14"
                            y="14"
                            width="7"
                            height="7"
                        ></rect>
                        <rect
                            x="3"
                            y="14"
                            width="7"
                            height="7"
                        ></rect>
                    </svg>
                    <span>Dashboard</span>
                </a>

                <a
                    href="#students"
                    class="sidebar-link"
                    data-tab="students"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2">
                        </path>
                        <circle
                            cx="9"
                            cy="7"
                            r="4"
                        ></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>My Students</span>
                </a>

                <a
                    href="#flagged"
                    class="sidebar-link"
                    data-tab="flagged"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                        ></path>
                        <line
                            x1="12"
                            y1="9"
                            x2="12"
                            y2="13"
                        ></line>
                        <line
                            x1="12"
                            y1="17"
                            x2="12.01"
                            y2="17"
                        ></line>
                    </svg>
                    <span>Flagged Messages</span>
                </a>

                <!-- Private Messaging tab -->
                <a
                    href="#messages"
                    class="sidebar-link"
                    data-tab="messages"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                        ></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Message Student</span>
                </a>

                <!-- Password Change Tab -->
                <a
                    href="#password"
                    class="sidebar-link"
                    data-tab="password"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect
                            x="3"
                            y="11"
                            width="18"
                            height="11"
                            rx="2"
                            ry="2"
                        ></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Change Password</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="3"
                                y="11"
                                width="18"
                                height="11"
                                rx="2"
                                ry="2"
                            ></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <div class="user-info">
                        <p class="user-email">{{ session.get('email',
                            'counselor@imhss.edu') }}</p>
                        <p class="user-role">Counselor</p>
                    </div>
                </div>
                <a
                    href="{{ url_for('IMHSS.logout') }}"
                    class="signout-btn"
                >
                    <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4">
                        </path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line
                            x1="21"
                            y1="12"
                            x2="9"
                            y2="12"
                        ></line>
                    </svg>
                    <span>Sign Out</span>
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content-area">

            <!-- ============================================================
                 DASHBOARD TAB
                 ============================================================ -->
            <section
                id="dashboard-tab"
                class="tab-content active"
            >
                <div class="content-header">
                    <h1>Counselor Dashboard</h1>
                    <p class="content-subtitle">Monitor your students' wellbeing
                    </p>
                    <button
                        id="enable-notifications-btn"
                        class="btn-enable-notifications"
                        style="display: none;"
                    >
                        <svg
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"
                            ></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        Enable Notifications
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-cards-grid">
                    <div class="stat-card-modern teal">
                        <div class="stat-content">
                            <p class="stat-label">My Students</p>
                            <h2 class="stat-number">{{
                                my_students_count|default(0) }}/5</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle
                                    cx="9"
                                    cy="7"
                                    r="4"
                                ></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="stat-card-modern orange">
                        <div class="stat-content">
                            <p class="stat-label">Flagged Messages</p>
                            <h2 class="stat-number">{{
                                flagged_messages_count|default(0) }}</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                ></path>
                                <line
                                    x1="12"
                                    y1="9"
                                    x2="12"
                                    y2="13"
                                ></line>
                                <line
                                    x1="12"
                                    y1="17"
                                    x2="12.01"
                                    y2="17"
                                ></line>
                            </svg>
                        </div>
                    </div>

                    <div class="stat-card-modern gray">
                        <div class="stat-content">
                            <p class="stat-label">Total Messages</p>
                            <h2 class="stat-number">{{
                                total_messages_count|default(0) }}</h2>
                        </div>
                        <div class="stat-icon">
                            <svg
                                width="32"
                                height="32"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        {% if my_students_count|default(0) <
                            5
                            %}
                            <a
                            href="{{ url_for('IMHSS.counselor_create_student') }}"
                            class="action-btn"
                        >
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                                ></path>
                                <circle
                                    cx="8.5"
                                    cy="7"
                                    r="4"
                                ></circle>
                                <line
                                    x1="20"
                                    y1="8"
                                    x2="20"
                                    y2="14"
                                ></line>
                                <line
                                    x1="23"
                                    y1="11"
                                    x2="17"
                                    y2="11"
                                ></line>
                            </svg>
                            Register New Student
                            </a>
                            {% endif %}
                            <a
                                href="#flagged"
                                class="action-btn"
                                data-tab="flagged"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                    ></path>
                                </svg>
                                Review Flagged Messages
                            </a>
                            <a
                                href="#messages"
                                class="action-btn"
                                data-tab="messages"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                                    ></path>
                                    <polyline points="22,6 12,13 2,6">
                                    </polyline>
                                </svg>
                                Message a Student
                            </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent High-Risk Alerts</h3>
                    {% if high_risk_flags %}
                    <div class="activity-list">
                        {% for flag in high_risk_flags[:5] %}
                        <div class="activity-item urgent">
                            <div class="activity-icon">⚠️</div>
                            <div class="activity-details">
                                <p class="activity-student">{{ flag.student.name
                                    if flag.student else 'Unknown' }}</p>
                                <p class="activity-message">{{
                                    flag.message.content[:100] if flag.message
                                    else 'Message unavailable' }}...</p>
                                <p class="activity-keywords">Keywords: {{ ',
                                    '.join(flag.detected_keywords) }}</p>
                                <p class="activity-time">{{
                                    flag.flagged_at.strftime('%B %d, %Y at %I:%M
                                    %p') if flag.flagged_at else 'Unknown time'
                                    }}</p>
                            </div>
                            <a
                                href="#flagged"
                                class="view-btn"
                                data-tab="flagged"
                            >Review</a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <p>No high-risk messages flagged</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- ============================================================
                        STUDENTS TAB
                        ============================================================ -->
            <div
                id="students-tab"
                class="tab-content"
            >
                <div class="tab-header">
                    <h2>My Students</h2>
                    <p class="tab-subtitle">{{ my_students_count }} students
                        assigned</p>
                    <a
                        href="{{ url_for('IMHSS.counselor_create_student') }}"
                        class="register-btn"
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <line
                                x1="12"
                                y1="5"
                                x2="12"
                                y2="19"
                            ></line>
                            <line
                                x1="5"
                                y1="12"
                                x2="19"
                                y2="12"
                            ></line>
                        </svg>
                        Register New Student
                    </a>
                </div>
            
                {% if my_students %}
                <div class="students-grid">
                    {% for student in my_students %}
                    <div
                        class="student-card {% if student.token_expired %}token-expired{% endif %}">
                        <div class="student-card-header">
                            <div class="student-avatar">{{
                                student.name[0].upper() }}</div>
                            <div class="student-info">
                                <h3>{{ student.name }}</h3>
                                <p class="student-matric">{{ student.matric }}
                                </p>
                                <p class="student-dept">{{ student.department }}
                                </p>
                            </div>
            
                            {% if student.token_expired %}
                            <span class="token-badge expired">
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <circle
                                        cx="12"
                                        cy="12"
                                        r="10"
                                    ></circle>
                                    <line
                                        x1="15"
                                        y1="9"
                                        x2="9"
                                        y2="15"
                                    ></line>
                                    <line
                                        x1="9"
                                        y1="9"
                                        x2="15"
                                        y2="15"
                                    ></line>
                                </svg>
                                Token Expired
                            </span>
                            {% elif student.days_until_expiry <=
                                2
                                %}
                                <span
                                class="token-badge expiring-soon"
                            >
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                    ></path>
                                </svg>
                                Expires in {{ student.days_until_expiry }} day{{
                                's' if student.days_until_expiry != 1 else '' }}
                                </span>
                                {% else %}
                                <span class="token-badge active">
                                    <svg
                                        width="14"
                                        height="14"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <polyline points="20 6 9 17 4 12">
                                        </polyline>
                                    </svg>
                                    {{ student.days_until_expiry }} days left
                                </span>
                                {% endif %}
                        </div>
            
                        <div class="student-card-body">
                            <div class="student-detail">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value">{{ student.email
                                    }}</span>
                            </div>
                            <div class="student-detail">
                                <span class="detail-label">Hall:</span>
                                <span class="detail-value">{{
                                    student.hostel_hall }} -
                                    Room {{ student.room_number
                                    }}</span>
                            </div>
                            <div class="student-detail">
                                <span class="detail-label">
                                    Gender:</span>
                                <span class="detail-value">{{
                                    student.gender
                                    }}</span>
                            </div>
                            <div class="student-detail">
                                <span class="detail-label">Guardian
                                    Contact:</span>
                                <span class="detail-value">{{
                                    student.parent_contact
                                    }}</span>
                            </div>
                            <div class="student-detail">
                                <span class="detail-label">Access
                                    Token:</span>
                                <span class="detail-value token-display">{{
                                    student.access_token }}</span>
                            </div>
                            {% if student.token_expires_at %}
                            <div class="student-detail">
                                <span class="detail-label">Token
                                    Expires:</span>
                                <span class="detail-value">{{
                                    student.token_expires_at.strftime('%b %d, %Y
                                    %I:%M %p') }}</span>
                            </div>
                            {% endif %}
                        </div>
            
                        <div class="student-card-actions">
                            <a
                                href="{{ url_for('IMHSS.counselor_view_student_messages', student_id=student._id) }}"
                                class="btn-view-messages"
                            >
                                <svg
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                                    ></path>
                                    <line
                                        x1="12"
                                        y1="9"
                                        x2="12"
                                        y2="13"
                                    ></line>
                                    <line
                                        x1="12"
                                        y1="17"
                                        x2="12.01"
                                        y2="17"
                                    ></line>
                                </svg>
                                View Flagged Messages
                            </a>
            
                            {% if student.token_expired or
                            student.days_until_expiry <=
                                2
                                %}
                                <form
                                action="{{ url_for('IMHSS.counselor_regenerate_token', student_id=student._id) }}"
                                method="POST"
                                style="display: inline;"
                                onsubmit="return confirm('Generate new 7-day token for {{ student.name }}?');"
                            >
                                <button
                                    type="submit"
                                    class="btn-regenerate-token"
                                >
                                    <svg
                                        width="16"
                                        height="16"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <polyline points="23 4 23 10 17 10">
                                        </polyline>
                                        <polyline points="1 20 1 14 7 14">
                                        </polyline>
                                        <path
                                            d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                                        ></path>
                                    </svg>
                                    {% if student.token_expired %}Generate New
                                    Token{% else %}Renew Token Early{% endif %}
                                </button>
                                </form>
                                {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <svg
                        width="64"
                        height="64"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2">
                        </path>
                        <circle
                            cx="9"
                            cy="7"
                            r="4"
                        ></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h3>No Students Yet</h3>
                    <p>Register your first student to get started</p>
                </div>
                {% endif %}
            </div>

            <!-- ============================================================
                 FLAGGED MESSAGES TAB
                 ============================================================ -->
            <section
                id="flagged-tab"
                class="tab-content"
            >
                <div class="content-header">
                    <h1>Flagged Messages</h1>
                    <p class="content-subtitle">Review high-risk student
                        messages</p>
                </div>

                {% if high_risk_flags %}
                <div class="flagged-messages-list">
                    {% for flag in high_risk_flags %}
                    <div
                        class="flag-card {% if not flag.reviewed %}urgent{% endif %}">
                        <div class="flag-header">
                            <div class="flag-student">
                                <div class="student-avatar-small">
                                    {{ flag.student.name[0].upper() if
                                    flag.student else '?' }}
                                </div>
                                <div>
                                    <h4>{{ flag.student.name if flag.student
                                        else 'Unknown Student' }}</h4>
                                    <p class="flag-time">{{
                                        flag.flagged_at.strftime('%B %d, %Y at
                                        %I:%M %p') if flag.flagged_at else
                                        'Unknown time' }}</p>
                                </div>
                            </div>
                            {% if not flag.reviewed %}
                            <span class="risk-badge high">High Risk</span>
                            {% else %}
                            <span class="risk-badge reviewed">Reviewed</span>
                            {% endif %}
                        </div>

                        <div class="flag-content">
                            <div class="flag-keywords">
                                <strong>Detected Keywords:</strong>
                                {% for keyword in flag.detected_keywords %}
                                <span class="keyword-tag">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                            <div class="flag-message">
                                <p><strong>Student Message:</strong></p>
                                <p class="message-text">{{ flag.message.content
                                    if flag.message else 'Message unavailable'
                                    }}</p>
                            </div>
                            <div class="flag-ai-response">
                                <p><strong>AI Response:</strong></p>
                                <p class="response-text">{{
                                    flag.message.ai_response if flag.message
                                    else 'Response unavailable' }}</p>
                            </div>
                        </div>

                        {% if not flag.reviewed %}
                        <div class="flag-actions">
                            <form
                                method="POST"
                                action="{{ url_for('IMHSS.counselor_review_flag', flag_id=flag._id) }}"
                                class="review-form"
                            >
                                <textarea
                                    name="notes"
                                    placeholder="Add notes about your follow-up action..."
                                    rows="2"
                                    class="review-notes"
                                ></textarea>
                                <button
                                    type="submit"
                                    class="btn-mark-reviewed"
                                >Mark as Reviewed</button>
                            </form>
                        </div>
                        {% else %}
                        <div class="flag-reviewed-info">
                            <p><strong>Reviewed by:</strong> You on {{
                                flag.reviewed_at.strftime('%B %d, %Y at %I:%M
                                %p') if flag.reviewed_at else 'Unknown' }}</p>
                            {% if flag.notes %}
                            <p><strong>Notes:</strong> {{ flag.notes }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state-large">
                    <svg
                        width="64"
                        height="64"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <h3>No Flagged Messages</h3>
                    <p>All clear! No high-risk messages require your attention.
                    </p>
                </div>
                {% endif %}
            </section>

            <!-- ============================================================
                 MESSAGE STUDENT TAB
                 Private counselor → student email. Admin has no access.
                 Only students with at least one flag are selectable.
                 ============================================================ -->
            <section
                id="messages-tab"
                class="tab-content"
            >
                <div class="content-header">
                    <h1>Message Student</h1>
                    <p class="content-subtitle">Send a private email directly to
                        a flagged student. Only you can see these messages</p>
                </div>

                <!-- COMPOSE FORM -->
                <div class="compose-card">
                    <div class="compose-card-header">
                        <svg
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                            ></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        <h3>Compose Message</h3>
                    </div>

                    {% if messageable_students %}
                    <form
                        method="POST"
                        action="{{ url_for('IMHSS.counselor_send_message') }}"
                        class="compose-form"
                    >

                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="student_id"
                            >
                                To (Flagged Student)
                                <span class="compose-label-hint">— only students
                                    with a risk flag appear here</span>
                            </label>
                            <select
                                name="student_id"
                                id="student_id"
                                class="compose-select"
                                required
                            >
                                <option
                                    value=""
                                    disabled
                                    selected
                                >Select a student…</option>
                                {% for s in messageable_students %}
                                <option value="{{ s._id }}">{{ s.name }} — {{
                                    s.email }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="subject"
                            >Subject</label>
                            <input
                                type="text"
                                name="subject"
                                id="subject"
                                class="compose-input"
                                placeholder="e.g. Checking in on you"
                                maxlength="200"
                                required
                            >
                        </div>

                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="body"
                            >Message</label>
                            <textarea
                                name="body"
                                id="body"
                                class="compose-textarea"
                                rows="7"
                                maxlength="4000"
                                placeholder="Write your message here. The student will receive this directly in their email inbox."
                                required
                            ></textarea>
                            <p class="compose-char-hint">
                                <span id="bodyCount">0</span> / 4000 characters
                            </p>
                        </div>

                        <div class="compose-meta">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <circle
                                    cx="12"
                                    cy="12"
                                    r="10"
                                ></circle>
                                <line
                                    x1="12"
                                    y1="16"
                                    x2="12"
                                    y2="12"
                                ></line>
                                <line
                                    x1="12"
                                    y1="8"
                                    x2="12.01"
                                    y2="8"
                                ></line>
                            </svg>
                            <span>This email will be sent from <strong>
                                        The IMHMS Support Team</strong>. The
                                student can reply directly to you. The admin
                                cannot read these messages.</span>
                        </div>

                        <div class="compose-actions">
                            <button
                                type="submit"
                                class="btn-send-message"
                            >
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <line
                                        x1="22"
                                        y1="2"
                                        x2="11"
                                        y2="13"
                                    ></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2">
                                    </polygon>
                                </svg>
                                Send Message
                            </button>
                        </div>
                    </form>

                    {% else %}
                    <div class="compose-empty">
                        <svg
                            width="48"
                            height="48"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="1.5"
                        >
                            <path
                                d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                            ></path>
                            <line
                                x1="12"
                                y1="9"
                                x2="12"
                                y2="13"
                            ></line>
                            <line
                                x1="12"
                                y1="17"
                                x2="12.01"
                                y2="17"
                            ></line>
                        </svg>
                        <p>No students with flagged messages yet.</p>
                        <p class="compose-empty-sub">You can only message
                            students who have triggered a risk flag. Check back
                            after a student's message has been flagged.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- SENT MESSAGES HISTORY -->
                <div class="sent-messages-section">
                    <h3 class="sent-messages-title">
                        <svg
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path
                                d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                            ></path>
                        </svg>
                        Sent Messages
                        <span class="sent-privacy-note">visible to you
                            only</span>
                    </h3>

                    {% if sent_messages %}
                    <div class="sent-messages-list">
                        {% for msg in sent_messages %}
                        <div
                            class="sent-message-card {% if msg.email_status == 'failed' %}send-failed{% endif %}">
                            <div class="sent-message-header">
                                <div class="sent-to-info">
                                    <div class="sent-avatar">{{
                                        msg.student_name[0].upper() if
                                        msg.student_name else '?' }}</div>
                                    <div>
                                        <p class="sent-student-name">{{
                                            msg.student_name }}</p>
                                        <p class="sent-student-email">{{
                                            msg.student_email }}</p>
                                    </div>
                                </div>
                                <div class="sent-message-meta">
                                    <span class="sent-date">{{
                                        msg.sent_at.strftime('%b %d, %Y %I:%M
                                        %p') if msg.sent_at else '—' }}</span>
                                    {% if msg.email_status == 'sent' %}
                                    <span class="sent-status-badge delivered">
                                        <svg
                                            width="12"
                                            height="12"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2.5"
                                        >
                                            <polyline points="20 6 9 17 4 12">
                                            </polyline>
                                        </svg>
                                        Delivered
                                    </span>
                                    {% else %}
                                    <span class="sent-status-badge failed">
                                        <svg
                                            width="12"
                                            height="12"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2.5"
                                        >
                                            <circle
                                                cx="12"
                                                cy="12"
                                                r="10"
                                            ></circle>
                                            <line
                                                x1="12"
                                                y1="8"
                                                x2="12"
                                                y2="12"
                                            ></line>
                                            <line
                                                x1="12"
                                                y1="16"
                                                x2="12.01"
                                                y2="16"
                                            ></line>
                                        </svg>
                                        Failed
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="sent-message-body">
                                <p class="sent-subject">{{ msg.subject }}</p>
                                <p class="sent-preview">{{ msg.body[:200] }}{%
                                    if msg.body|length > 200 %}…{% endif %}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="sent-empty">
                        <p>No messages sent yet.</p>
                    </div>
                    {% endif %}
                </div>
            </section>
            <!-- ============================================================
                        PASSWORD CHANGE TAB
                ============================================================ -->
            <section
                id="password-tab"
                class="tab-content"
            >
                <div class="content-header">
                    <h1>Change Password</h1>
                    <p class="content-subtitle">Update your account password. Use a strong
                        password with at least 8 characters.</p>
                </div>
            
                <!-- PASSWORD CHANGE FORM -->
                <div
                    class="compose-card"
                    style="max-width: 600px;"
                >
                    <div class="compose-card-header">
                        <svg
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="3"
                                y="11"
                                width="18"
                                height="11"
                                rx="2"
                                ry="2"
                            ></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <h3>Update Password</h3>
                    </div>
            
                    <form
                        method="POST"
                        action="{{ url_for('IMHSS.change_password') }}"
                        class="compose-form"
                        id="password-change-form"
                    >
                        <!-- Current Password -->
                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="current_password"
                            >
                                Current Password
                            </label>
                            <input
                                type="password"
                                name="current_password"
                                id="current_password"
                                class="compose-input"
                                placeholder="Enter your current password"
                                required
                                autocomplete="current-password"
                            >
                        </div>
            
                        <!-- New Password -->
                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="new_password"
                            >
                                New Password
                            </label>
                            <input
                                type="password"
                                name="new_password"
                                id="new_password"
                                class="compose-input"
                                placeholder="Enter your new password"
                                required
                                minlength="8"
                                autocomplete="new-password"
                            >
                            <div
                                id="password-strength"
                                class="password-strength-indicator"
                                style="margin-top: 8px;"
                            ></div>
                        </div>
            
                        <!-- Confirm New Password -->
                        <div class="compose-field">
                            <label
                                class="compose-label"
                                for="confirm_password"
                            >
                                Confirm New Password
                            </label>
                            <input
                                type="password"
                                name="confirm_password"
                                id="confirm_password"
                                class="compose-input"
                                placeholder="Re-enter your new password"
                                required
                                minlength="8"
                                autocomplete="new-password"
                            >
                            <p
                                id="password-match-message"
                                style="margin-top: 8px; font-size: 0.875rem;"
                            ></p>
                        </div>
            
                        <!-- Password Requirements -->
                    <div
                        style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #5a8a9c;">
                        <h4
                            style="margin: 0 0 12px 0; color: #2d3748; font-size: 0.875rem; font-weight: 600;">
                            Password Requirements:</h4>
                        <ul
                            style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 0.875rem; line-height: 1.6;">
                            <li>At least 8 characters long</li>
                            <li>Include a mix of uppercase and lowercase letters
                                (recommended)</li>
                            <li>Include numbers and special characters (recommended)</li>
                            <li>Avoid using common words or personal information</li>
                        </ul>
                    </div>
            
                        <!-- Submit Button -->
                        <div class="compose-actions">
                            <button
                                type="submit"
                                class="btn-send-message"
                                id="change-password-btn"
                            >
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script src="/static/js/Dashboard.js"></script>
</body>

</html>